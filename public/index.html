<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Yolo</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.0/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./style.css">
  </head>
  <body>
    <h1 class = "title"> YOLO HOME </h1>
    <div class = "block">
      <div class = "item">
        <div>Led</div>
        <div onclick = "changeLed(event)">
          <input name = "value" id="toggle-btn" type="checkbox" checked data-toggle="toggle" data-size="lg" value = "1">
        </div>
        <p id="led-value"></p>
      </div>
      <div class = "item">
        <!-- <label for="customRange1" class="form-label"> Quạt</label>
        <input oninput = "changeFan(event)" type="range" class="form-range" id="customRange1" max = "100">
        <p id="range-value"></p> -->
        <div class = "group-button">
          <button style = "color: red"class = "button-fan" name = "off"onclick = "handleChangeFan(event)">Tắt</button>
          <button style= "color: yellow"class = "button-fan" name = "low" onclick = "handleChangeFan(event)">Chậm</button>
          <button style= "color: rgb(37, 175, 125)"class = "button-fan" name = "medium" onclick = "handleChangeFan(event)">Vừa</button>
          <button style= "color: green" class = "button-fan" name = "high" onclick = "handleChangeFan(event)">Nhanh</button>
        </div>
        <p id="speed-value"></p>

      </div>

      <div style= "height: 300px;" class = "item">
        <div>Nhiệt độ</div> 
        <p id="temp-value"></p>  
      </div>
      
      

      <div style= "height: 400px;"class = "item">
        <form id="myForm">
          <input type="text" name="value1" >
          <button onClick="changeTemp(event)">POST TEMP</button>
        </form>
        <div>Lịch sử nhiệt độ</div> 
      <canvas style= "height: 100px"id="myChart"></canvas>
      </div>

      <div class = "item">
        <div>Độ sáng</div> 
        <p id="lux-value"></p>
      </div>

      <div class = "item">
        <div>Lịch sử độ sáng</div> 
        <p id=""></p>
      </div>

      <div class = "item">
        <div>Độ ẩm</div> 
        <p id="humid-value"></p>
      </div>
      
      <div class = "item">
        <div>Lịch sử độ ẩm</div> 
        <p id=""></p>
      </div>

      <div class = "item">
        <div>Trợ lý ảo</div> 
        <p id="assistant-value"> </p>
      </div>



    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
      const tempValue = document.getElementById("temp-value");
      const humidValue = document.getElementById("humid-value");
      const luxValue = document.getElementById("lux-value");
      const ledValue = document.getElementById("led-value");
      const fanspValue = document.getElementById("speed-value");
      const assistantValue = document.getElementById("assistant-value");
      let isFlag = false;
      let responseLed;
      let chartData;
      const currentValue = document.querySelector('[name="value"]')
      //const range = document.querySelector('#customRange1');
      let myChart
      //let data
      const fetchData = async () => {
     
        responseLed = await axios.get("http://localhost:8080/lastLed");
    
        ledValue.innerHTML = `Giá trị: ${responseLed.data.value}`;  
      
        if(responseLed.data.value == 0 && isFlag == false){
          $('#toggle-btn').bootstrapToggle('off')
          currentValue.value = 0;
          isFlag = true;
        } 

        const reponseFansp = await axios.get("http://localhost:8080/lastFansp");
        fanspValue.innerHTML = `Giá trị: ${reponseFansp.data.value}`;
        // range.value = reponseFansp.data.value;

        const responseTemp = await axios.get("http://localhost:8080/lastTemp");
        tempValue.innerHTML = `Giá trị: ${responseTemp.data.value}`;
  
        const reponseLux = await axios.get("http://localhost:8080/lastLux");
        luxValue.innerHTML = `Giá trị: ${reponseLux.data.value}`;
        
        const responseHumid = await axios.get("http://localhost:8080/lastHumid");
        humidValue.innerHTML = `Giá trị: ${responseHumid.data.value}`;

        chartData = await axios.get("http://localhost:8080/tempChart");
       
        const reponseAssistant = await axios.get("http://localhost:8080/lastAssistant");
        assistantValue.innerHTML = `Giá trị: ${reponseAssistant.data.value}`;

        const ctx = document.getElementById('myChart').getContext('2d');
      
        
        //console.log(window.myChart)
        //console.log(myChart)
        if (myChart) {
          // If chart exists, update data
        //  console.log(myChart.data)
          myChart.data.labels = chartData.data.map(item => item.name);
       
          myChart.data.datasets[0].data = chartData.data.map(item => item.temperatureOfChip);
          myChart.update();
        } else {
       
          myChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: chartData.data.map(item => item.name),
              datasets: [{
                label: 'Temperature',
                data: chartData.data.map(item => item.temperatureOfChip),
                borderColor: 'rgba(255, 99, 132, 1)',
                fill: false
              }]
            },
            options: {
              responsive: true,
      
            }
          });
        }
      }
      
      // Lấy dữ liệu mới mỗi 3s
      fetchData();

      setInterval(fetchData, 3000)
     
      

    
    
      
    </script>

    

    <script>
      function changeLed(e) {
        e.preventDefault();
        let updatedValue
        let toggleLed = document.querySelector("#toggle-btn")
        console.log(toggleLed.value)
        if(toggleLed.value == "1") {
          updatedValue = "0"
          toggleLed.value = 0
        }else {
          updatedValue = "1"
          toggleLed.value = 1
        }
        axios.post('/lastLed', { value: updatedValue})
          .then(response => console.log(response))
          .catch(error => console.error(error));
      }

      function changeFan(e) {
        e.preventDefault();
        const range = document.querySelector('#customRange1');
        const value = range.value;
        axios.post('/lastFan', { value: value})
          .then(response => console.log(response))
          .catch(error => console.error(error));
      }

      function handleChangeFan(e){
        e.preventDefault();
        let value;
        const valueChangeFan = e.target.name
        console.log(valueChangeFan)
        if(valueChangeFan == "off") {
          value = "0"
        }else if(valueChangeFan == "low") {
          value = "30"
        }else if(valueChangeFan == "medium") {
          value = "60"
        }else {
          value = "100"
        }

        axios.post('/lastFan', { value: value})
          .then(response => console.log(response))
          .catch(error => console.error(error))
      }
      let a = 2;

      function changeTemp(e){
      e.preventDefault();
      const tempNew = document.querySelector('[name="value1"]').value
      


       
        axios.post('/lastTemp', { value: tempNew})
          .then(response => console.log(response))
          .catch(error => console.error(error))
      }
    </script>

  </body>
</html>
