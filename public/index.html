<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Yolo</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.0/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./style.css">
  </head>
  <body>
    <h1 class = "title"> YOLO HOME </h1>
    <div class = "container">
      <div class = "item1">
         <!-- Đèn: toggle-button để tắt bật đèn -->
         <div class = "item led">
            <div>Led</div>
            <div onclick = "changeLed(event)">
              <input name = "value" id="toggle-btn" type="checkbox" checked data-toggle="toggle" data-size="lg" value = "1">
            </div>
            <!-- <p id="led-value"></p> -->
          </div>

          <!-- Quạt: 4 nút: Tắt, chậm, trung bình, nhanh -->
          <div class = "item fan">
            <h2>Quạt</h2>
            <div class = "group-button">
              <button style = "color: red" class = "button-fan" name = "off"onclick = "changeFan(event)">Tắt</button>
              <button style= "color: rgb(35, 25, 223)"class = "button-fan" name = "low" onclick = "changeFan(event)">Chậm</button>
              <button style= "color: rgb(37, 175, 125)"class = "button-fan" name = "medium" onclick = "changeFan(event)">Vừa</button>
              <button style= "color: green" class = "button-fan" name = "high" onclick = "changeFan(event)">Nhanh</button>
            </div>
        
            <div style = "font-size: 30px; "class="sensor-value">
              <span>Tốc độ:  </span> 
              <span id="speed-value">-</span>
              <span class="units">%</span>
            </div>
          </div>

          <!-- Trợ lý ảo: Thông báo khi vượt ngưỡng -->
          <div class = "item assistant">
            <h2>Trợ lý ảo</h2> 
            <p id="assistant-value"> - </p>
          </div>
      </div>

      <div class = "item2">
        <!-- Hiển thị nhiệt độ -->
        <div class = "item sensor-style">
          <div>
            <span>Nhiệt độ</span>
          </div>
          <div class="sensor-value">
            <!-- <img src="./images/temperature.png" width="80" height="80" alt=""> -->
            <span id="temp-value">-</span>
            <span class="units">&#8451;</span>
          </div>
        </div>

        <!-- Hiển thị độ sáng -->
        <div class = "item sensor-style">
          <div>Độ sáng</div> 
          <div class="sensor-value">
            <span id="lux-value">-</span>
            <span class="units">LUX</span>
          </div>
        </div>

        <!-- Hiển thị độ ẩm -->
        <div  class = "item sensor-style">
          <div>Độ ẩm</div> 
          <div class="sensor-value">
            <span id="humid-value"></span>
            <span class="units">%</span>
          </div>
        </div>
      </div>
      <div class = "item3">
        <!-- Hiển thị biểu đồ -->
        <div class = "item">
          <div class = "title-chart">Lịch sử Nhiệt độ</div> 
          <!-- Biểu đồ nhiệt độ -->
          <div class="chart">
            <canvas id="tempChart"></canvas>
          </div> 
        </div>

        <!-- Biểu độ hiển thị độ sáng -->
        <div class = "item">
          <div>Lịch sử độ sáng</div> 
          <p id=""></p>
          <div class="chart">
            <canvas id="luxChart"></canvas>
          </div>
        </div>

          <!-- Biểu đồ hiển thị độ ẩm -->
        <div class = "item">
          <div>Lịch sử độ ẩm</div> 
          <p id=""></p>
          <div class="chart">
              <canvas id="humidChart"></canvas>
          </div>
        </div>
      </div>
      
    </div>
    <div style = "display: flex; flex-direction: row;">
      <!-- Form test biểu đồ hoạt động khi dữ liệu thay đổi -->
      <form>
        <input type="text" name="valueTemp" >
        <button onClick="changeTemp(event)">POST TEMP</button>
      </form>

      <form>
        <input type="text" name="valueLux" >
        <button onClick="changeLux(event)">POST LUX</button>
      </form>

      <form>
        <input type="text" name="valueHumid" >
        <button onClick="changeHumid(event)">POST HUMID</button>
      </form>
    </div>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
      
      const tempValue = document.getElementById("temp-value");
      const luxValue = document.getElementById("lux-value");
      const humidValue = document.getElementById("humid-value");
      // const ledValue = document.getElementById("led-value");
      const assistantValue = document.getElementById("assistant-value");
      const fanspValue = document.getElementById("speed-value");
      const currentValue = document.querySelector('[name="value"]')
      // Biến dùng để kiểm soát có biểu đồ hay chưa
      let tempChart, luxChart, humidChart

      // Biến dùng để kiểm tra xem gửi thông báo ngưỡng đến người dùng chưa
      let isAlertLux = false

      const fetchData = async () => {
        // Lấy dữ liệu của các cảm biến
        const responseTemp = await axios.get("http://localhost:8080/lastTemp");
        tempValue.innerHTML = `${responseTemp.data.value}`;

        const reponseLux = await axios.get("http://localhost:8080/lastLux");
        luxValue.innerHTML = `${reponseLux.data.value}`;
        
        const responseHumid = await axios.get("http://localhost:8080/lastHumid");
        humidValue.innerHTML = `${responseHumid.data.value}`;
        
         /* if(reponseLux.data.value < 400 && isAlertLux == false) {
            const alertLux = confirm(`Giá trị độ sáng đang là ${responseHumid.data.value}, quá thấp. Bạn có muốn bật đèn không ?`)
            isAlertLux = true;
            if(alertLux) {
                //Bấm OK    
            }else {
                // Bấm No
            }
          }  */
        
        const responseLed = await axios.get("http://localhost:8080/lastLed");
       // ledValue.innerHTML = `Giá trị: ${responseLed.data.value}`;
        //Sét trạng thái ban đầu của nút Tắt/bật đèn, 0=>off
        if(responseLed.data.value == 0){
          $('#toggle-btn').bootstrapToggle('off')
          currentValue.value = 0;
        } 
        
        const reponseAssistant = await axios.get("http://localhost:8080/lastAssistant");
        assistantValue.innerHTML = `${reponseAssistant.data.value}`;
        
        const reponseFansp = await axios.get("http://localhost:8080/lastFansp");
        fanspValue.innerHTML = `${reponseFansp.data.value}`;
        
        const tempChartData = await axios.get("http://localhost:8080/tempChart");
        const luxChartData = await axios.get("http://localhost:8080/luxChart");
        const humidChartData = await axios.get("http://localhost:8080/humidChart");
        const temp = document.getElementById('tempChart').getContext('2d');
        const lux = document.getElementById('luxChart').getContext('2d');
        const humid = document.getElementById('humidChart').getContext('2d');
      
        // Nếu chưa có biểu đồ => tạo biểu đồ trong hàm else
        // Nếu có biểu đồ => cập nhất biểu đồ trong hàm if
    
        if (tempChart) {
          tempChart.data.labels = tempChartData.data.map(item => item.name);
          tempChart.data.datasets[0].data = tempChartData.data.map(item => item.temperatureOfChip);
          tempChart.update();
        } else {
          tempChart = new Chart(temp, {
            type: 'line',
            data: {
              labels: tempChartData.data.map(item => item.name),
              datasets: [{
                label: 'Nhiệt độ',
                data: tempChartData.data.map(item => item.temperatureOfChip),
                borderColor: '3e21fb',
                fill: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              aspectRatio: 3
            }
          });
        }

        if (luxChart) {
          luxChart.data.labels = luxChartData.data.map(item => item.name);
          luxChart.data.datasets[0].data = luxChartData.data.map(item => item.luxOfChip);
          luxChart.update();
        } else {
          console.log(luxChartData)
          luxChart = new Chart(lux, {
            type: 'line',
            data: {
              labels: luxChartData.data.map(item => item.name),
              datasets: [{
                label: 'Độ sáng',
                data: luxChartData.data.map(item => item.luxOfChip),
                borderColor: '#dc1717',
                fill: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              aspectRatio: 3
            }
          });
        }

        if (humidChart) {
          humidChart.data.labels = humidChartData.data.map(item => item.name);
          humidChart.data.datasets[0].data = humidChartData.data.map(item => item.humidOfChip);
          humidChart.update();
        } else {
          humidChart = new Chart(humid, {
            type: 'line',
            data: {
              labels: humidChartData.data.map(item => item.name),
              datasets: [{
                label: 'Độ ẩm',
                data: humidChartData.data.map(item => item.humidOfChip),
                borderColor: '#2eb05e',
                fill: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              aspectRatio: 3
            }
          });
        }

        
      }      
      fetchData();
      // Lấy dữ liệu mới mỗi 3s
      // Thời gian lấy dữ liệu không được quá thấp vì server chạy không nổi
      setInterval(fetchData, 3000)  
    </script>
    <script>

      // Hàm tắt/bật đền
      function changeLed(e) {
        // Ngăn trạng thái chuyển trang khi POST
        e.preventDefault();
        let updatedValue
        let toggleLed = document.querySelector("#toggle-btn")
        // Kiểm tra giá trị toggleLed trước đang là bao nhiêu
        // Nếu là 0 => POST 1, value = 1
        // Nếu là 1 => POST 0, value = 0
        if(toggleLed.value == "1") {
          updatedValue = "0"
          toggleLed.value = 0
        }else {
          updatedValue = "1"
          toggleLed.value = 1
        }
        axios.post('/lastLed', { value: updatedValue})
          .then(response => console.log(response))
          .catch(error => console.error(error));
      }

      // Hàm thay đổi độ lớn của quạt
      function changeFan(e){
        e.preventDefault();
        let value;
        const valueChangeFan = e.target.name
        // Kiểm tra xem bấm vào nút gì, off->0, low->30, medium->60, high->100
        if(valueChangeFan == "off") {
          value = "0"
        }else if(valueChangeFan == "low") {
          value = "30"
        }else if(valueChangeFan == "medium") {
          value = "60"
        }else {
          value = "100"
        }
        axios.post('/lastFan', { value: value})
          .then(response => console.log(response))
          .catch(error => console.error(error))
      }
      
      // Hàm check sự thay đổi của biểu đồ nhiệt độ khi có nhiệt độ mới
      function changeTemp(e){
      e.preventDefault();
      const tempNew = document.querySelector('[name="valueTemp"]').value       
        axios.post('/lastTemp', { value: tempNew})
          .then(response => console.log(response))
          .catch(error => console.error(error))
      }

      function changeLux(e){
        e.preventDefault();
        const luxNew = document.querySelector('[name="valueLux"]').value       
          axios.post('/lastLux', { value: luxNew})
            .then(response => console.log(response))
            .catch(error => console.error(error))
      }

      function changeHumid(e){
        e.preventDefault();
        const humidNew = document.querySelector('[name="valueHumid"]').value       
          axios.post('/lastHumid', { value: humidNew})
            .then(response => console.log(response))
            .catch(error => console.error(error))
      }

        
    </script>

  </body>
</html>
